name: ğŸ› ï¸ Build FreeSWITCH Debian11 [zhenxi flow]

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:11

    steps:
      - name: ğŸ§± å®‰è£…ä¾èµ–
        run: |
          apt update
          apt install -y build-essential g++ git file binutils \
            autoconf automake libtool pkg-config \
            libncurses5-dev libssl-dev libedit-dev libsqlite3-dev libcurl4-openssl-dev \
            libpcre3-dev libspeexdsp-dev libopus-dev libsndfile1-dev \
            libavformat-dev libswscale-dev liblua5.4-dev libpq-dev uuid-dev \
            yasm cmake unzip ca-certificates wget

      - name: ğŸ“¥ ä¸‹è½½ FreeSWITCH æºç 
        run: |
          wget https://github.com/signalwire/freeswitch/archive/refs/tags/v1.10.10.tar.gz
          tar -xzf v1.10.10.tar.gz
          mv freeswitch-1.10.10 freeswitch

      - name: ğŸ”§ ç¼–è¯‘ FreeSWITCH
        working-directory: ./freeswitch
        run: |
          ./bootstrap.sh -j
          export CFLAGS="-Wno-error -Wno-error=deprecated-declarations -Wno-error=unused-function -Wno-error=array-parameter"
          ./configure --prefix=/opt/freeswitch \
            --disable-core-odbc-support --disable-dependency-tracking \
            --enable-static-modules --without-pgsql
          make -j$(nproc)
          make install

      - name: ğŸ“¦ æ‰“åŒ…ä¸º tar.gz
        run: |
          tar -czf freeswitch-debian11.tar.gz -C /opt/freeswitch .

      - name: ğŸª› æäº¤æ„å»ºäº§ç‰©å›ä»“åº“
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

          mkdir -p build-freeswitch-for-debian11
          mv freeswitch-debian11.tar.gz build-freeswitch-for-debian11/

          echo "ğŸ“¦ å½“å‰æ–‡ä»¶ï¼š"
          find build-freeswitch-for-debian11 -type f

          git pull origin ${{ github.ref_name }} || true
          git add build-freeswitch-for-debian11/freeswitch-debian11.tar.gz || true
          git commit -m "ğŸ¤– è‡ªåŠ¨æ·»åŠ æ„å»ºäº§ç‰©ï¼šFreeSWITCH Debian 11 tar.gz" || echo "ğŸ“­ æ— éœ€æäº¤"
          git push origin HEAD:${{ github.ref_name }} || echo "âš ï¸ push å¤±è´¥ï¼Œæ£€æŸ¥æƒé™æˆ–åˆ†æ”¯ä¿æŠ¤"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§ª Debug è¾“å‡ºæ„å»ºæ—¥å¿—ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
        if: failure()
        run: |
          echo "â›ï¸ æ„å»ºå¤±è´¥ï¼Œå°è¯•è¯»å– config.log"
          cat freeswitch/config.log || echo "âš ï¸ config.log æœªæ‰¾åˆ°"
